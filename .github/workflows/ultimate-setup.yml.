name: Codex Ultimate Pro Setup
on: 
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ç¡®ä¿æœ‰æƒé™åˆ›å»º Release

    steps:
      - name: 1. æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: 2. æ™ºèƒ½ç¯å¢ƒé…ç½® (Python/Node/Go/Java)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: 3. è‡ªåŠ¨åŒ–ä¾èµ–å®‰è£…ä¸é«˜é˜¶æ£€æŸ¥
        run: |
          python -m pip install --upgrade pip
          pip install ruff bandit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          ruff check . || echo "è·³è¿‡é£æ ¼æ£€æŸ¥"
          bandit -r . -ll || echo "è·³è¿‡å®‰å…¨æ‰«æ"

      - name: 4. è‡ªåŠ¨åŒ–è½¯ä»¶æ‰“åŒ…
        run: |
          mkdir -p dist
          # æ‰“åŒ…æ‰€æœ‰æ ¸å¿ƒæ–‡ä»¶ï¼Œæ’é™¤æ‰ä¸å¿…è¦çš„ git è®°å½•
          zip -r codex-app.zip . -x "*.git*" ".github*"
          mv codex-app.zip dist/
          echo "âœ… è½¯ä»¶æ‰“åŒ…å®Œæˆ"

      - name: 5. è‡ªåŠ¨å‘å¸ƒè‡³ GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Codex Release v${{ github.run_number }}
          body: |
            ğŸš€ **Codex è‡ªåŠ¨åŒ–æ„å»ºæˆåŠŸï¼**
            - æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
            - æ„å»ºç¼–å·: ${{ github.run_number }}
            - ä¸‹è½½ä¸‹æ–¹çš„ `codex-app.zip` å³å¯ä½¿ç”¨ã€‚
          files: dist/codex-app.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 6. æœ€ç»ˆç»“æœæ±‡æ€»
        run: |
          echo "--------------------------------------------------"
          echo "ğŸ‰ ç¯å¢ƒé…ç½®ä¸è½¯ä»¶å‘å¸ƒå…¨éƒ¨æˆåŠŸï¼"
          echo "ğŸ”— æœ€æ–°ç‰ˆä¸‹è½½åœ°å€ï¼š"
          echo "https://github.com/${{ github.repository }}/releases/latest"
          echo "--------------------------------------------------"
